BX.namespace("BX.Iblock.Catalog"),BX.Iblock.Catalog.CompareClass=function(){var t=function(t){this.app=RS.Application(),this.errorCode=0,this.obCompare=null,this.node={},this.config={name:"CATALOG_COMPARE_LIST",iblockId:null},this.items=[],this.obItems=[],"object"==typeof t&&(this.visual=t.VISUAL,this.config.name=t.CONFIG.NAME,this.config.iblockId=t.CONFIG.IBLOCK_ID,this.ajaxUrl=t.CONFIG.TEMPLATE_FOLDER+"/ajax.php",this.items=t.ITEMS),this.app.breakpoints?this.breakpoints=this.app.breakpoints:this.breakpoints={xxs:0,xs:480,sm:768,md:992,lg:1200},0===this.errorCode&&BX.ready(BX.delegate(this.init,this))};return t.prototype={init:function(){var t;if(this.obCompare=BX(this.visual.ID),this.obTable=BX(this.visual.TABLE),this.obCompare||(this.errorCode=-1),this.node.columnNames=this.obCompare.querySelector('[data-entity="column-names"]'),this.node.columnItems=this.obCompare.querySelector('[data-entity="column-items"]'),this.node.itemsTable=this.obCompare.querySelector('[data-entity="items-table"]'),this.obItems=[],this.node.itemsTable){var e=this.node.itemsTable.querySelectorAll('[data-entity="compare-item"]');for(t in e)e.hasOwnProperty(t)&&this.obItems.push(e[t])}for(t in this.obItems)BX.bind(this.obItems[t],"mouseover",BX.proxy(this.compareItemDragInit,this));this.setRhythm();var i=this.node.columnItems;$(this.node.columnItems).scrollbar({onUpdate:function(t){var e=$(i).find("thead"),s=$(this.wrapper).find(".scroll-element.scroll-x");s.css({top:e.position().top+e.outerHeight()+$(i).find("tbody > tr:first-child").outerHeight()/2-s.outerHeight()/2})}}),BX.data(this.obCompare,"cmpRes",this),$(window).on("resize",BX.debounce($.proxy(this.setRhythm,this),250)),BX.addCustomEvent(window,"OnCompareSort",BX.proxy(this.compareSort,this))},MakeAjaxAction:function(t,e){this.showWait(),BX.ajax.post(t,{ajax_action:"Y",ajax_id:this.visual.ID},BX.proxy(function(t){this.obCompare.innerHTML=t,this.init(),this.closeWait()},this)),e&&BX.PreventDefault(e)},compareSort:function(){var t={action:"compare-sort",ITEMS:[]};if(this.node.itemsTable){var e=this.node.itemsTable.querySelectorAll('[data-entity="compare-item"]');for(i in e)if(e.hasOwnProperty(i)){var s=this.obItems.indexOf(e[i]);t.ITEMS.push(this.items[s])}}this.sendRequest(t)},compareSortResult:function(){},sendRequest:function(t){var e={siteId:this.siteId,AJAX:"Y",NAME:this.config.name,IBLOCK_ID:this.config.iblockId};BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:BX.merge(e,t),onsuccess:BX.delegate(function(e){this.showAction(e,t)},this)})},showAction:function(t,e){if(e)switch(e.action){case"compare-sort":this.compareSortResult(t)}},setRhythm:function(){var t=BX.findChildren(this.node.itemsTable,{tag:"tr"},!0),e=BX.findChildren(this.node.columnNames,{tag:"tr"},!0);if(e&&e.length>0&&t&&t.length){var s=-1,o={};o[this.breakpoints.xxs]={items:1},o[this.breakpoints.sm]={items:2},o[this.breakpoints.md]={items:3};for(var r in o)(r=Number(r))<=this.app.getWidth()&&r>s&&(s=r);for(this.node.itemsTable.style.width=100*BX.findChildren(t[0],{tag:"td"},!0).length/o[s].items+"%",i=0;e.length>i;i++)e[i].style.height=t[i].style.height="auto",t[i].offsetHeight>e[i].offsetHeight?e[i].style.height=t[i].offsetHeight+"px":t[i].style.height=e[i].offsetHeight+"px"}},showWait:function(){BX.addClass(this.obCompare,"overlay is-loading")},closeWait:function(){BX.removeClass(this.obCompare,"overlay is-loading")},compareItemDragStart:function(){var t=document.body.appendChild(document.createElement("DIV"));return t.style.position="absolute",t.style.zIndex=1100,t.className="bx-drag-object",t.innerHTML=this.innerHTML,t.style.width=this.clientWidth+"px",this.__dragCopyDiv=t,!0},compareItemDrag:function(t,e){var i=this.__dragCopyDiv,s=this.__currentDest;if(i.style.left=t+"px",i.style.top=e+"px",s){var o=BX.pos(s);if(t-o.left<o.width/2)(r=BX.previousSibling(s))&&BX.addClass(r,"is-hover"),BX.removeClass(s,"is-hover");else{var r=BX.previousSibling(s);r&&BX.removeClass(r,"is-hover"),BX.addClass(s,"is-hover")}}return!0},compareItemDragStop:function(){return this.className=this.className.replace(/\s*bx-grid-drag-source/gi,""),this.__dragCopyDiv.parentNode.removeChild(this.__dragCopyDiv),this.__dragCopyDiv=null,!0},compareItemDragHover:function(t,e,i){this.__currentDest=this!=t?t:null},compareItemDragOut:function(t,e,i){var s=BX.previousSibling(t);s&&BX.removeClass(s,"is-hover"),BX.removeClass(t,"is-hover")},compareItemDestDragFinish:function(t,e,i,s){var o=this,r=BX.findChildren(t.parentNode),a=r.indexOf(t),n=r.indexOf(o),h=BX.pos(o),m=BX.findParent(o,{tagName:"table"});BX.removeClass(t,"is-hover"),BX.removeClass(o,"is-hover");var l=BX.previousSibling(o);if(l&&BX.removeClass(l,"is-hover"),m){var d=BX.findChildren(m,{tagName:"tr"},!0);if(d.length)for(var p in d){var c=d[p].children.item(a),u=d[p].children.item(n);c&&u&&(e-h.left<h.width/2?u.parentNode.insertBefore(c,u):u.parentNode.insertBefore(c,u.nextSibling))}}BX.onCustomEvent("OnCompareSort")},compareItemDragInit:function(){var t=BX.proxy_context.parentNode;void 0==t.onbxdragstart&&(t.onbxdragstart=this.compareItemDragStart,t.onbxdragstop=this.compareItemDragStop,t.onbxdrag=this.compareItemDrag,t.onbxdraghover=this.compareItemDragHover,t.onbxdraghout=this.compareItemDragOut,t.onbxdestdragfinish=this.compareItemDestDragFinish,jsDD.registerObject(t),jsDD.registerDest(t),BX.unbind(t,"mouseover",BX.proxy(this.compareItemDragInit,this)))}},t}();