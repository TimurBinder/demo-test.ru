BX.namespace("BX.Iblock.Catalog"),BX.Iblock.Catalog.CompareClass=function(){var t=function(t){this.app=RS.Application(),this.errorCode=0,this.obCompare=null,this.node={},this.config={name:"CATALOG_COMPARE_LIST",iblockId:null},this.items=[],this.obItems=[],"object"==typeof t&&(this.visual=t.VISUAL,this.config.name=t.CONFIG.NAME,this.config.iblockId=t.CONFIG.IBLOCK_ID,this.ajaxUrl=t.CONFIG.TEMPLATE_FOLDER+"/ajax.php",this.items=t.ITEMS),this.app.breakpoints?this.breakpoints=this.app.breakpoints:this.breakpoints={xxs:0,xs:480,sm:768,md:992,lg:1200},0===this.errorCode&&BX.ready(BX.delegate(this.init,this))};return t.prototype.MakeAjaxAction=function(t,e){this.showWait(),BX.ajax.post(t,{ajax_action:"Y",ajax_id:this.visual.ID},BX.proxy(this.reloadResult,this)),e&&BX.PreventDefault(e)},t.prototype.reload=function(){BX.showWait(BX(this.wrapObjId)),BX.ajax.post(this.reloadUrl,{compare_result_reload:"Y"},BX.proxy(this.reloadResult,this))},t.prototype.reloadResult=function(t){this.obCompare.innerHTML=t,this.init(),this.closeWait()},t.prototype.delete=function(t){BX.showWait(BX(this.wrapObjId)),BX.ajax.post(t,{ajax_action:"Y"},BX.proxy(this.deleteResult,this))},t.prototype.deleteResult=function(t){BX.closeWait(),BX.onCustomEvent("OnCompareChange"),BX(this.wrapObjId).innerHTML=t},t.prototype.init=function(){var t;if(this.obCompare=BX(this.visual.ID),this.obTable=BX(this.visual.TABLE),this.obCompare||(this.errorCode=-1),this.node.columnNames=this.obCompare.querySelector('[data-entity="column-names"]'),this.node.columnItems=this.obCompare.querySelector('[data-entity="column-items"]'),this.node.itemsTable=this.obCompare.querySelector('[data-entity="items-table"]'),this.obItems=[],this.node.itemsTable){var e=this.node.itemsTable.querySelectorAll('[data-entity="compare-item"]');for(t in e)e.hasOwnProperty(t)&&this.obItems.push(e[t])}for(t in this.obItems)BX.bind(this.obItems[t],"mouseover",BX.proxy(this.compareItemDragInit,this));this.setRhythm();var i=this.node.columnItems;$(this.node.columnItems).scrollbar({onUpdate:function(t){var e=$(i).find("thead"),o=$(this.wrapper).find(".scroll-element.scroll-x");o.css({top:e.position().top+e.outerHeight()+$(i).find("tbody > tr:first-child").outerHeight()/2-o.outerHeight()/2})}}),BX.data(this.obCompare,"cmpRes",this),$(window).on("resize",BX.debounce($.proxy(this.setRhythm,this),250)),BX.addCustomEvent(window,"OnCompareSort",BX.proxy(this.compareSort,this))},t.prototype.compareSort=function(){var t={action:"compare-sort",ITEMS:[]};if(this.node.itemsTable){var e=this.node.itemsTable.querySelectorAll('[data-entity="compare-item"]');for(i in e)if(e.hasOwnProperty(i)){var o=this.obItems.indexOf(e[i]);t.ITEMS.push(this.items[o])}}this.sendRequest(t)},t.prototype.compareSortResult=function(){},t.prototype.sendRequest=function(t){var e={siteId:this.siteId,AJAX:"Y",NAME:this.config.name,IBLOCK_ID:this.config.iblockId};BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:BX.merge(e,t),onsuccess:BX.delegate(function(e){this.showAction(e,t)},this)})},t.prototype.sendRequest=function(t,e){if(e)switch(e.action){case"compare-sort":this.compareSortResult(t)}},t.prototype.setRhythm=function(){var t=BX.findChildren(this.node.itemsTable,{tag:"tr"},!0),e=BX.findChildren(this.node.columnNames,{tag:"tr"},!0);if(e&&e.length>0&&t&&t.length){var o=-1,s={};s[this.breakpoints.xxs]={items:1},s[this.breakpoints.sm]={items:2},s[this.breakpoints.md]={items:3};for(var r in s)(r=Number(r))<=this.app.getWidth()&&r>o&&(o=r);for(this.node.itemsTable.style.width=100*BX.findChildren(t[0],{tag:"td"},!0).length/s[o].items+"%",i=0;e.length>i;i++)e[i].style.height=t[i].style.height="auto",t[i].offsetHeight>e[i].offsetHeight?e[i].style.height=t[i].offsetHeight+"px":t[i].style.height=e[i].offsetHeight+"px"}},t.prototype.showWait=function(){BX.addClass(this.obCompare,"overlay is-loading")},t.prototype.closeWait=function(){BX.removeClass(this.obCompare,"overlay is-loading")},t.prototype.compareItemDragStart=function(){var t=document.body.appendChild(document.createElement("DIV"));return t.style.position="absolute",t.style.zIndex=1100,t.className="bx-drag-object",t.innerHTML=this.innerHTML,t.style.width=this.clientWidth+"px",this.__dragCopyDiv=t,!0},t.prototype.compareItemDrag=function(t,e){var i=this.__dragCopyDiv,o=this.__currentDest;if(i.style.left=t+"px",i.style.top=e+"px",o){var s=BX.pos(o);if(t-s.left<s.width/2)(r=BX.previousSibling(o))&&BX.addClass(r,"is-hover"),BX.removeClass(o,"is-hover");else{var r=BX.previousSibling(o);r&&BX.removeClass(r,"is-hover"),BX.addClass(o,"is-hover")}}return!0},t.prototype.compareItemDragStop=function(){return this.className=this.className.replace(/\s*bx-grid-drag-source/gi,""),this.__dragCopyDiv.parentNode.removeChild(this.__dragCopyDiv),this.__dragCopyDiv=null,!0},t.prototype.compareItemDragHover=function(t,e,i){this.__currentDest=this!=t?t:null},t.prototype.compareItemDragOut=function(t,e,i){var o=BX.previousSibling(t);o&&BX.removeClass(o,"is-hover"),BX.removeClass(t,"is-hover")},t.prototype.compareItemDestDragFinish=function(t,e,i,o){var s=this,r=BX.findChildren(t.parentNode),a=r.indexOf(t),n=r.indexOf(s),h=BX.pos(s),p=BX.findParent(s,{tagName:"table"});BX.removeClass(t,"is-hover"),BX.removeClass(s,"is-hover");var l=BX.previousSibling(s);if(l&&BX.removeClass(l,"is-hover"),p){var m=BX.findChildren(p,{tagName:"tr"},!0);if(m.length)for(var d in m){var c=m[d].children.item(a),u=m[d].children.item(n);c&&u&&(e-h.left<h.width/2?u.parentNode.insertBefore(c,u):u.parentNode.insertBefore(c,u.nextSibling))}}BX.onCustomEvent("OnCompareSort")},t.prototype.compareItemDragInit=function(){var t=BX.proxy_context.parentNode;void 0==t.onbxdragstart&&(t.onbxdragstart=this.compareItemDragStart,t.onbxdragstop=this.compareItemDragStop,t.onbxdrag=this.compareItemDrag,t.onbxdraghover=this.compareItemDragHover,t.onbxdraghout=this.compareItemDragOut,t.onbxdestdragfinish=this.compareItemDestDragFinish,jsDD.registerObject(t),jsDD.registerDest(t),BX.unbind(t,"mouseover",BX.proxy(this.compareItemDragInit,this)))},t}();